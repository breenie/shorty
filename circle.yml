---

machine:
    timezone: Europe/London
    php:
        version: 5.4.4 # Seems to be the lowest version in circleci.
    node:
        version: 0.12.0
dependencies:
    override:
        # Stop the circleci composer install getting confused by download type "vcs"
        - composer install --prefer-dist --no-interaction
        - npm install

test:
    override:
        - mkdir -p $CIRCLE_TEST_REPORTS/junit
        - php bin/phpunit --coverage-text --log-junit $CIRCLE_TEST_REPORTS/junit/junit.xml
        - grunt test

deployment:
    production:
        branch: master
        commands:
            - git push dokku@apps.kurl.io:shorty $CIRCLE_SHA1:refs/heads/master

    testing:
        branch: "feature/viaduct"
        commands:
            - curl -X POST -s -H "X-Auth-Token: ${VDT_API_TOKEN}" -H "X-Auth-Secret: ${VDT_API_SECRET}" https://api.viaduct.io/api/v1/deployments/start --data-urlencode 'params={"application":"shorty-stage","version":"${CIRCLE_SHA1}"}'

    staging:
        branch: develop
        commands:
            - git push dokku@apps.kurl.io:shorty-stage $CIRCLE_SHA1:refs/heads/master
